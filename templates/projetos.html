{% extends "base.html" %}

{% block title %}Portifolio - Projetos{% endblock %}

{% block content %}
<section id="inicio" class="p-5 pb-md-5 text-white">
    <div id="github-projects" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
</div>

</section>
{% endblock %}

{% block scripts %}
<script>
  async function carregarProjetos() {
    const username = "GuilhermeSecco";
    const url = `https://api.github.com/users/${username}/repos?sort=updated&per_page=100`;
    
    const container = document.getElementById("github-projects");
    const loading = document.getElementById("loading-projects");

    const coresTopicos = {
      "python": "primary",
      "machine-learning": "success",
      "power-bi": "warning",
      "mysql": "info",
      "streamlit": "danger",
      "selenium": "danger",
      "dashboard": "secondary",
      "excel": "success",
      "html": "danger",
      "css" : "primary",
      "javascript": "warning",
      "bootstrap": "success",
      "flask" : "info"
    }

    function formatarTopico(texto) {
    return texto
    .replace(/[-_]/g, " ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .split(" ")
    .map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase())
    .join(" ");
}

    try {
      let repos = [];

    for (let page = 1; page <= 3; page++) {
      const resposta = await fetch(
        `https://api.github.com/users/${username}/repos?sort=updated&per_page=100&page=${page}`,
        { headers: { "Accept": "application/vnd.github.mercy-preview+json" } }
      );
      if (!resposta.ok) throw new Error("Erro ao buscar repositórios.");
      const data = await resposta.json();
      repos = repos.concat(data);
      if (data.length < 100) break;
    }

      const projetos = repos.filter(r =>
        r.topics && r.topics.includes("portfolio-project")
      );

      if (projetos.length === 0) {
        loading.innerText = "Nenhum projeto marcado como 'portfolio-project' encontrado.";
        return;
      }

      container.innerHTML = projetos.map(repo => `
          <div class="col">
            <div class="card bg-dark border border-secondary shadow-sm h-100">
              <img src="/static/img/projects/${repo.name.replaceAll('-', ' ')}.png"
                   class="card-img-top" alt="Preview de ${repo.name.replaceAll('-',' ')}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light fw-bold">${repo.name.replace(/-/g, ' ')}</h5>
                <div class="mb-3">
                  ${repo.topics
                    .filter(t => t.toLowerCase() !== "portfolio-project" && t.toLowerCase() !== "portfolio-demo")
                    .map(t => `
                      <span class="badge text-shadow bg-${coresTopicos[t.toLowerCase()] || 'secondary'} me-1">
                        ${formatarTopico(t)}
                      </span>
                    `)
                  .join('')}
                </div>
                <p class="card-text text-white small flex-grow-1">${repo.description || "Sem descrição disponível."}</p>

                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-warning small">
                    <i class="bi bi-star-fill"></i> ${repo.stargazers_count}
                  </div>
                  <div class="d-flex gap-2">
                    ${repo.topics.includes("portfolio-demo")
                      ? `<a href="/projetos/${repo.name.toLowerCase()}"
                           target="_blank" class="btn btn-outline-danger text-white">
                            Acessar Demonstração <i class="bi bi-box-arrow-up-right"></i>
                         </a>`
                      : ""}
                    <a href="${repo.html_url}" target="_blank" class="btn btn-outline-primary text-white">
                       Ver no GitHub <i class="bi bi-github"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join("");

      loading.style.display = "none";

    } catch (erro) {
      console.error("Erro ao carregar projetos:", erro);
      loading.innerText = "Erro ao carregar os projetos";
    }
  }

  document.addEventListener("DOMContentLoaded", carregarProjetos);
</script>
{% endblock %}
